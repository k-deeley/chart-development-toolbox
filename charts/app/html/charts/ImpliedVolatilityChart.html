<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>ImpliedVolatilityChart</title>
<meta name="generator" content="MATLAB 25.1">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2025-01-11">
<meta name="DC.source" content="ImpliedVolatilityChart.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<pre class="codeinput">
<span class="keyword">classdef</span> ImpliedVolatilityChart &lt; Component
    <span class="comment">%IMPLIEDVOLATILITYCHART Chart managing 3D scattered data comprising</span>
    <span class="comment">%strike price, time to expiry and implied volatility, together with an</span>
    <span class="comment">%interpolated implied volatility surface.</span>

    <span class="comment">% Copyright 2018-2025 The MathWorks, Inc.</span>

    <span class="keyword">properties</span> ( Dependent )
        <span class="comment">% Table of option data, comprising the time to expiry, strike</span>
        <span class="comment">% price, implied volatility and underlying asset price.</span>
        OptionData<span class="typesection">(:, 4) table {mustBeOptionData}</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Dependent )</span>

    <span class="keyword">properties</span>
        <span class="comment">% Marker for the scattered data.</span>
        Marker<span class="typesection">(1, 1) string {mustBeMarker}</span> = <span class="string">"."</span>
        <span class="comment">% Size of the markers.</span>
        MarkerSize<span class="typesection">(1, 1) double {mustBePositive, mustBeFinite}</span> = 6
        <span class="comment">% Marker face color.</span>
        MarkerFaceColor <span class="typesection">{validatecolor}</span> = <span class="string">"k"</span>
        <span class="comment">% Marker edge color.</span>
        MarkerEdgeColor <span class="typesection">{validatecolor}</span> = <span class="string">"k"</span>
    <span class="keyword">end</span> <span class="comment">% properties</span>

    <span class="keyword">properties</span> ( Dependent, AbortSet )
        <span class="comment">% Volatility curve interpolation method.</span>
        InterpolationMethod<span class="typesection">(1, 1) string </span><span class="keyword">...</span>
            <span class="typesection">{mustBeMember( InterpolationMethod, </span><span class="keyword">...</span>
            <span class="typesection">["linear", "spline", "pchip", "makima", </span><span class="keyword">...</span>
            <span class="typesection">"Hagan2002", "Obloj2008"] )}</span> = <span class="string">"pchip"</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Dependent, AbortSet )</span>

    <span class="keyword">properties</span> ( Dependent )
        <span class="comment">% Visibility of the chart controls.</span>
        Controls<span class="typesection">(1, 1) matlab.lang.OnOffSwitchState</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Dependent )</span>

    <span class="keyword">properties</span> ( Access = private )
        <span class="comment">% Internal storage for the OptionData property.</span>
        OptionData_<span class="typesection">(:, 4) table {mustBeOptionData}</span> = defaultOptionData()
        <span class="comment">% Internal storage for the InterpolationMethod property.</span>
        InterpolationMethod_<span class="typesection">(1, 1) string </span><span class="keyword">...</span>
            <span class="typesection">{mustBeMember( InterpolationMethod_, </span><span class="keyword">...</span>
            <span class="typesection">["linear", "spline", "pchip", "makima", </span><span class="keyword">...</span>
            <span class="typesection">"Hagan2002", "Obloj2008"] )}</span> = <span class="string">"pchip"</span>
        <span class="comment">% Logical scalar specifying whether a computation is required.</span>
        ComputationRequired<span class="typesection">(1, 1) logical </span>= false
    <span class="keyword">end</span> <span class="comment">% properties ( Access = private )</span>

    <span class="keyword">properties</span> ( Dependent, Access = private )
        <span class="comment">% Vector of unique expiry times.</span>
        UniqueExpiryTimes<span class="typesection">(:, 1) double {mustBePositive, mustBeFinite}</span>
        <span class="comment">% Vector of finely subdivided strike prices.</span>
        FineStrike<span class="typesection">(:, 1) double {mustBePositive, mustBeFinite}</span>
        <span class="comment">% Surface z-data (implied volatilities).</span>
        VolatilityGrid<span class="typesection">(:, :) double {mustBePositive, mustBeFinite}</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Dependent, Access = private )</span>

    <span class="keyword">properties</span> ( Access = private, Transient, NonCopyable )
        <span class="comment">% Chart layout.</span>
        LayoutGrid<span class="typesection">(:, 1) matlab.ui.container.GridLayout </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% Chart axes.</span>
        Axes<span class="typesection">(:, 1) matlab.graphics.axis.Axes </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% Toggle button for the chart controls.</span>
        ToggleButton<span class="typesection">(:, 1) matlab.ui.controls.ToolbarStateButton </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% Implied volatility surface.</span>
        Surface<span class="typesection">(:, 1) matlab.graphics.primitive.Surface </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% 3D scattered data, plotted using a line object.</span>
        Line<span class="typesection">(:, 1) matlab.graphics.primitive.Line </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% Implied volatility interpolation method dropdown menu.</span>
        InterpolationMethodDropDown<span class="typesection">(:, 1) matlab.ui.control.DropDown </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
        <span class="comment">% Colorbar check box.</span>
        ColorbarCheckBox<span class="typesection">(:, 1) matlab.ui.control.CheckBox </span><span class="keyword">...</span>
            <span class="typesection">{mustBeScalarOrEmpty}</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Access = private, Transient, NonCopyable )</span>

    <span class="keyword">properties</span> ( Constant, Hidden )
        <span class="comment">% Product dependencies.</span>
        Dependencies<span class="typesection">(1, :) string </span>= [<span class="string">"MATLAB"</span>, <span class="keyword">...</span>
            <span class="string">"Statistics and Machine Learning Toolbox"</span>, <span class="keyword">...</span>
            <span class="string">"Optimization Toolbox"</span>, <span class="keyword">...</span>
            <span class="string">"Financial Toolbox"</span>, <span class="keyword">...</span>
            <span class="string">"Financial Instruments Toolbox"</span>]
        <span class="comment">% Description.</span>
        ShortDescription<span class="typesection">(1, 1) string </span>= <span class="string">"Plot an implied "</span> + <span class="keyword">...</span>
            <span class="string">"volatility surface as a function of the option strike"</span> + <span class="keyword">...</span>
            <span class="string">" price and time to expiry"</span>
    <span class="keyword">end</span> <span class="comment">% properties ( Constant, Hidden )</span>

    <span class="keyword">methods</span>

        <span class="keyword">function</span> value = get.OptionData( obj )

            value = obj.OptionData_;

        <span class="keyword">end</span> <span class="comment">% get.OptionData</span>

        <span class="keyword">function</span> set.OptionData( obj, value )

            <span class="comment">% Mark the chart for an update.</span>
            obj.ComputationRequired = true;

            <span class="comment">% Set the internal data property.</span>
            obj.OptionData_ = value;

        <span class="keyword">end</span> <span class="comment">% set.OptionData</span>

        <span class="keyword">function</span> value = get.InterpolationMethod( obj )

            value = obj.InterpolationMethod_;

        <span class="keyword">end</span> <span class="comment">% get.InterpolationMethod</span>

        <span class="keyword">function</span> set.InterpolationMethod( obj, value )

            <span class="comment">% Mark the chart for an update.</span>
            obj.ComputationRequired = true;

            <span class="comment">% Update the dropdown menu if necessary.</span>
            obj.InterpolationMethodDropDown.Value = value;

            <span class="comment">% Assign the interpolation method.</span>
            obj.InterpolationMethod_ = value;

        <span class="keyword">end</span> <span class="comment">% set.InterpolationMethod</span>

        <span class="keyword">function</span> value = get.Controls( obj )

            value = obj.ToggleButton.Value;

        <span class="keyword">end</span> <span class="comment">% get.Controls</span>

        <span class="keyword">function</span> set.Controls( obj, value )

            <span class="comment">% Update the toggle button.</span>
            obj.ToggleButton.Value = value;

            <span class="comment">% Invoke the toggle button callback.</span>
            obj.onToggleButtonPressed()

        <span class="keyword">end</span> <span class="comment">% set.Controls</span>

        <span class="keyword">function</span> value = get.UniqueExpiryTimes( obj )

            value = unique( obj.OptionData_.(1) );

        <span class="keyword">end</span> <span class="comment">% get.UniqueExpiryTimes</span>

        <span class="keyword">function</span> value = get.FineStrike( obj )

            <span class="comment">% Take the maximal interior domain of the strike prices across</span>
            <span class="comment">% each unique expiry time.</span>
            T = obj.UniqueExpiryTimes;
            <span class="keyword">for</span> k = numel( T ) : -1 : 1
                currentTIdx = obj.OptionData_.(1) == T(k);
                K = obj.OptionData_.(2);
                [mn(k, 1), mx(k, 1)] = bounds( K(currentTIdx) );
            <span class="keyword">end</span> <span class="comment">% for</span>
            mn = max( mn );
            mx = min( mx );
            value = linspace( mn, mx, 500 ).';

        <span class="keyword">end</span> <span class="comment">% get.FineStrike</span>

        <span class="keyword">function</span> sigma = get.VolatilityGrid( obj )

            <span class="comment">% For each unique expiry time, we interpolate the corresponding</span>
            <span class="comment">% volatility smile over the fine strike prices.</span>
            T = obj.UniqueExpiryTimes;
            K = obj.FineStrike;
            interpMethod = obj.InterpolationMethod;
            sigma = NaN( numel( K ), numel( T ) );

            <span class="keyword">switch</span> interpMethod
                <span class="comment">% Use INTERP1 to cover the basic cases.</span>
                <span class="keyword">case</span> {<span class="string">"linear"</span>, <span class="string">"spline"</span>, <span class="string">"pchip"</span>, <span class="string">"makima"</span>}
                    <span class="keyword">for</span> k = 1 : numel( T )
                        currentTIdx = obj.OptionData_.(1) == T(k);
                        currentK = obj.OptionData_{currentTIdx, 2};
                        currentVol = obj.OptionData_{currentTIdx, 3};
                        sigma(:, k) = interp1( currentK, currentVol, <span class="keyword">...</span>
                            K, interpMethod );
                    <span class="keyword">end</span> <span class="comment">% for</span>
                    <span class="comment">% Otherwise, we calibrate and evaluate the SABR model</span>
                    <span class="comment">% to obtain the implied volatilities.</span>
                <span class="keyword">case</span> {<span class="string">"Hagan2002"</span>, <span class="string">"Obloj2008"</span>}
                    sigma = sabr( obj );
                <span class="keyword">otherwise</span>
                    error( <span class="string">"ImpliedVolatility:InvalidInterpMethod"</span>, <span class="keyword">...</span>
                        <span class="string">"Unrecognized interpolation method %s."</span>, <span class="keyword">...</span>
                        interpMethod )
            <span class="keyword">end</span> <span class="comment">% switch/case</span>

            <span class="comment">% Ensure that all computed volatilities are nonnegative.</span>
            sigma = max( sigma, 0 );

        <span class="keyword">end</span> <span class="comment">% get.VolatilityGrid</span>

    <span class="keyword">end</span> <span class="comment">% methods</span>

    <span class="keyword">methods</span>

        <span class="keyword">function</span> obj = ImpliedVolatilityChart( namedArgs )
            <span class="comment">%IMPLIEDVOLATILITYCHART Construct an ImpliedVolatilityChart,</span>
            <span class="comment">%given optional name-value arguments.</span>

            <span class="keyword">arguments</span> ( Input )
                namedArgs.?ImpliedVolatilityChart
            <span class="keyword">end</span> <span class="comment">% arguments ( Input )</span>

            <span class="comment">% Set any user-defined properties.</span>
            set( obj, namedArgs )

        <span class="keyword">end</span> <span class="comment">% constructor</span>

        <span class="keyword">function</span> varargout = xlabel( obj, varargin )

            [varargout{1:nargout}] = xlabel( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% xlabel</span>

        <span class="keyword">function</span> varargout = ylabel( obj, varargin )

            [varargout{1:nargout}] = ylabel( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% ylabel</span>

        <span class="keyword">function</span> varargout = zlabel( obj, varargin )

            [varargout{1:nargout}] = zlabel( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% zlabel</span>

        <span class="keyword">function</span> varargout = title( obj, varargin )

            [varargout{1:nargout}] = title( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% title</span>

        <span class="keyword">function</span> varargout = colorbar( obj, varargin )

            <span class="comment">% Call the colorbar function on the chart's axes.</span>
            [varargout{1:nargout}] = colorbar( obj.Axes, varargin{:} );

            <span class="comment">% Ensure the colorbar check box is up-to-date.</span>
            obj.ColorbarCheckBox.Value = ~isempty( obj.Axes.Colorbar );

        <span class="keyword">end</span> <span class="comment">% colorbar</span>

        <span class="keyword">function</span> varargout = colormap( obj, varargin )

            [varargout{1:nargout}] = colormap( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% colormap</span>

        <span class="keyword">function</span> varargout = view( obj, varargin )

            [varargout{1:nargout}] = view( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% view</span>

        <span class="keyword">function</span> varargout = axis( obj, varargin )

            [varargout{1:nargout}] = axis( obj.Axes, varargin{:} );

        <span class="keyword">end</span> <span class="comment">% axis</span>

    <span class="keyword">end</span> <span class="comment">% methods</span>

    <span class="keyword">methods</span> ( Access = protected )

        <span class="keyword">function</span> setup( obj )
            <span class="comment">%SETUP Initialize the chart graphics.</span>

            <span class="comment">% Define the layout grid.</span>
            obj.LayoutGrid = uigridlayout( obj, [1, 2], <span class="keyword">...</span>
                <span class="string">"ColumnWidth"</span>, [<span class="string">"1x"</span>, <span class="string">"0x"</span>] );

            <span class="comment">% Create the chart's axes.</span>
            obj.Axes = axes( <span class="string">"Parent"</span>, obj.LayoutGrid, <span class="keyword">...</span>
                <span class="string">"XGrid"</span>, <span class="string">"on"</span>, <span class="keyword">...</span>
                <span class="string">"YGrid"</span>, <span class="string">"on"</span>, <span class="keyword">...</span>
                <span class="string">"ZGrid"</span>, <span class="string">"on"</span> );

            <span class="comment">% Add a state button to show/hide the chart's controls.</span>
            tb = axtoolbar( obj.Axes, <span class="string">"default"</span> );
            iconPath = fullfile( chartsRoot(), <span class="keyword">...</span>
                <span class="string">"charts"</span>, <span class="string">"images"</span>, <span class="string">"Cog.png"</span> );
            obj.ToggleButton = axtoolbarbtn( tb, <span class="string">"state"</span>, <span class="keyword">...</span>
                <span class="string">"Value"</span>, <span class="string">"on"</span>, <span class="keyword">...</span>
                <span class="string">"Tooltip"</span>, <span class="string">"Show chart controls"</span>, <span class="keyword">...</span>
                <span class="string">"Icon"</span>, iconPath, <span class="keyword">...</span>
                <span class="string">"ValueChangedFcn"</span>, @obj.onToggleButtonPressed );

            <span class="comment">% Create the line and surface plot.</span>
            obj.Line = line( <span class="string">"Parent"</span>, obj.Axes, <span class="keyword">...</span>
                <span class="string">"XData"</span>, NaN(), <span class="keyword">...</span>
                <span class="string">"YData"</span>, NaN(), <span class="keyword">...</span>
                <span class="string">"ZData"</span>, NaN(), <span class="keyword">...</span>
                <span class="string">"Marker"</span>, <span class="string">"."</span>, <span class="keyword">...</span>
                <span class="string">"Color"</span>, <span class="string">"k"</span>, <span class="keyword">...</span>
                <span class="string">"LineStyle"</span>, <span class="string">"none"</span> );
            obj.Surface = surface( obj.Axes, <span class="keyword">...</span>
                NaN(), NaN(), NaN(), NaN(), <span class="keyword">...</span>
                <span class="string">"FaceColor"</span>, <span class="string">"interp"</span>, <span class="keyword">...</span>
                <span class="string">"EdgeAlpha"</span>, 0 );
            <span class="comment">% Configure the chart's axes.</span>
            view( obj.Axes, 3 )

            <span class="comment">% Add the chart controls.</span>
            p = uipanel( <span class="string">"Parent"</span>, obj.LayoutGrid, <span class="keyword">...</span>
                <span class="string">"Title"</span>, <span class="string">"Chart Controls"</span>, <span class="keyword">...</span>
                <span class="string">"FontWeight"</span>, <span class="string">"bold"</span> );
            controlLayout = uigridlayout( p, [3, 2], <span class="keyword">...</span>
                <span class="string">"ColumnWidth"</span>, [<span class="string">"fit"</span>, <span class="string">"fit"</span>], <span class="keyword">...</span>
                <span class="string">"RowHeight"</span>, [<span class="string">"fit"</span>, <span class="string">"fit"</span>, <span class="string">"fit"</span>] );

            <span class="comment">% Interpolation methods dropdown menu.</span>
            uilabel( <span class="string">"Parent"</span>, controlLayout, <span class="keyword">...</span>
                <span class="string">"Text"</span>, <span class="string">"Interpolation method:"</span> );
            obj.InterpolationMethodDropDown = uidropdown( <span class="keyword">...</span>
                <span class="string">"Parent"</span>, controlLayout, <span class="keyword">...</span>
                <span class="string">"Items"</span>, [<span class="string">"linear"</span>, <span class="string">"spline"</span>, <span class="string">"pchip"</span>, <span class="keyword">...</span>
                <span class="string">"makima"</span>, <span class="string">"Hagan2002"</span>, <span class="string">"Obloj2008"</span>], <span class="keyword">...</span>
                <span class="string">"Tooltip"</span>, <span class="keyword">...</span>
                <span class="string">"Select the implied volatility interpolation method"</span>, <span class="keyword">...</span>
                <span class="string">"Value"</span>, obj.InterpolationMethod_, <span class="keyword">...</span>
                <span class="string">"ValueChangedFcn"</span>, @obj.onInterpolationMethodSelected );

            <span class="comment">% Colorbar check box.</span>
            obj.ColorbarCheckBox = uicheckbox( <span class="keyword">...</span>
                <span class="string">"Parent"</span>, controlLayout, <span class="keyword">...</span>
                <span class="string">"Text"</span>, <span class="string">"Colorbar"</span>, <span class="keyword">...</span>
                <span class="string">"Tooltip"</span>, <span class="string">"Show/hide the colorbar"</span>, <span class="keyword">...</span>
                <span class="string">"Value"</span>, false, <span class="keyword">...</span>
                <span class="string">"ValueChangedFcn"</span>, @obj.onColorbarSelected );
            obj.ColorbarCheckBox.Layout.Column = [1, 2];

        <span class="keyword">end</span> <span class="comment">% setup</span>

        <span class="keyword">function</span> update( obj )
            <span class="comment">%UPDATE Refresh the chart graphics.</span>

            <span class="keyword">if</span> obj.ComputationRequired

                <span class="comment">% Update the discrete data markers.</span>
                set( obj.Line, <span class="string">"XData"</span>, obj.OptionData_.(1), <span class="keyword">...</span>
                    <span class="string">"YData"</span>, obj.OptionData_.(2), <span class="keyword">...</span>
                    <span class="string">"ZData"</span>, obj.OptionData_.(3) )

                <span class="comment">% Update the volatility surface.</span>
                set( obj.Surface, <span class="string">"XData"</span>, obj.UniqueExpiryTimes, <span class="keyword">...</span>
                    <span class="string">"YData"</span>, obj.FineStrike, <span class="keyword">...</span>
                    <span class="string">"ZData"</span>, obj.VolatilityGrid, <span class="keyword">...</span>
                    <span class="string">"CData"</span>, obj.VolatilityGrid )

                <span class="comment">% Mark the chart clean.</span>
                obj.ComputationRequired = false;

            <span class="keyword">end</span> <span class="comment">% if</span>

            <span class="comment">% Refresh the chart's decorative properties.</span>
            set( obj.Line, <span class="string">"Marker"</span>, obj.Marker, <span class="keyword">...</span>
                <span class="string">"MarkerSize"</span>, obj.MarkerSize, <span class="keyword">...</span>
                <span class="string">"MarkerFaceColor"</span>, obj.MarkerFaceColor, <span class="keyword">...</span>
                <span class="string">"MarkerEdgeColor"</span>, obj.MarkerEdgeColor )

        <span class="keyword">end</span> <span class="comment">% update</span>

    <span class="keyword">end</span> <span class="comment">% methods ( Access = protected )</span>

    <span class="keyword">methods</span> ( Access = private )

        <span class="keyword">function</span> onToggleButtonPressed( obj, ~, ~ )
            <span class="comment">%ONTOGGLEBUTTONPRESSED Hide/show the chart controls.</span>

            toggleDown = obj.ToggleButton.Value;

            <span class="keyword">if</span> toggleDown
                <span class="comment">% Show the controls.</span>
                obj.LayoutGrid.ColumnWidth{2} = <span class="string">"fit"</span>;
                obj.ToggleButton.Tooltip = <span class="string">"Hide chart controls"</span>;
            <span class="keyword">else</span>
                <span class="comment">% Hide the controls.</span>
                obj.LayoutGrid.ColumnWidth{2} = <span class="string">"0x"</span>;
                obj.ToggleButton.Tooltip = <span class="string">"Show chart controls"</span>;
            <span class="keyword">end</span> <span class="comment">% if</span>

        <span class="keyword">end</span> <span class="comment">% onToggleButtonPressed</span>

        <span class="keyword">function</span> onInterpolationMethodSelected( obj, ~, ~ )
            <span class="comment">%ONINTERPOLATIONMETHODSELECTED Update the chart when the user</span>
            <span class="comment">%interactively selects an interpolation method.</span>

            obj.InterpolationMethod = <span class="keyword">...</span>
                obj.InterpolationMethodDropDown.Value;

        <span class="keyword">end</span> <span class="comment">% onInterpolationMethodSelected</span>

        <span class="keyword">function</span> onColorbarSelected( obj, ~, ~ )
            <span class="comment">%ONCOLORBARSELECTED Show/hide the colorbar.</span>

            checked = obj.ColorbarCheckBox.Value;
            <span class="keyword">if</span> checked
                colorbar( obj )
            <span class="keyword">else</span>
                colorbar( obj, <span class="string">"off"</span> )
            <span class="keyword">end</span> <span class="comment">% if</span>

        <span class="keyword">end</span> <span class="comment">% onColorbarSelected</span>

        <span class="keyword">function</span> sigma = sabr( obj )
            <span class="comment">%SABR Evaluate the implied volatility surface using the SABR</span>
            <span class="comment">%model.</span>

            <span class="comment">% Define the settlement date (an arbitrary date since we are</span>
            <span class="comment">% working with times to expiry). The exercise date will be the</span>
            <span class="comment">% settlement date plus the time to expiry.</span>
            settle = datetime( 2000, 1, 1 );

            <span class="comment">% For each unique time to expiry, we calibrate the SABR model</span>
            <span class="comment">% The calibrated SABR model is then used to interpolate the</span>
            <span class="comment">% implied volatilities across the range of finely subdivided</span>
            <span class="comment">% strike prices.</span>
            T = obj.UniqueExpiryTimes;
            <span class="keyword">for</span> k = numel( T ) : -1 : 1
                <span class="comment">% Compute the exercise date.</span>
                exercise = settle + years( T(k) );
                <span class="comment">% Extract the (K, sigma) values for each expiry time.</span>
                currentTIdx = obj.OptionData_.(1) == T(k);
                strike = obj.OptionData_{currentTIdx, 2};
                vol = obj.OptionData_{currentTIdx, 3};
                underlyingPrice = obj.OptionData_{currentTIdx, 4};
                <span class="comment">% Calibrate the other parameters alpha, rho and nu using</span>
                <span class="comment">% nonlinear least squares.</span>
                objFun = @( X ) vol - <span class="keyword">...</span>
                    blackvolbysabr( X(1), X(2), X(3), X(4), settle, <span class="keyword">...</span>
                    exercise, underlyingPrice, strike, <span class="keyword">...</span>
                    <span class="string">"Model"</span>, obj.InterpolationMethod );
                opts = optimoptions( <span class="string">"lsqnonlin"</span>, <span class="string">"Display"</span>, <span class="string">"off"</span> );
                X = lsqnonlin( objFun, [0.5, 0.2, 0, 0.5], <span class="keyword">...</span>
                    [0, 0, -1, 0], [Inf, 1, 1, Inf], opts );
                <span class="comment">% Interpolate the volatilities using the calibrated model.</span>
                sigma(:, k) = blackvolbysabr( X(1), X(2), X(3), X(4), <span class="keyword">...</span>
                    settle, exercise, <span class="keyword">...</span>
                    mean( underlyingPrice ), obj.FineStrike );
            <span class="keyword">end</span> <span class="comment">% for</span>

        <span class="keyword">end</span> <span class="comment">% sabr</span>

    <span class="keyword">end</span> <span class="comment">% methods ( Access = protected )</span>

<span class="keyword">end</span> <span class="comment">% classdef</span>

<span class="keyword">function</span> optData = defaultOptionData()
<span class="comment">%DEFAULTOPTIONDATA Create an empty table of option data.</span>

optData = table( <span class="string">'Size'</span>, [0, 4], <span class="keyword">...</span>
    <span class="string">'VariableTypes'</span>, [<span class="string">"double"</span>, <span class="string">"double"</span>, <span class="string">"double"</span>, <span class="string">"double"</span>], <span class="keyword">...</span>
    <span class="string">'VariableNames'</span>, [<span class="string">"T"</span>, <span class="string">"K"</span>, <span class="string">"Sigma"</span>, <span class="string">"S"</span>] );

<span class="keyword">end</span> <span class="comment">% defaultOptionData</span>

<span class="keyword">function</span> mustBeOptionData( t )
<span class="comment">%MUSTBEOPTIONDATA Validate that the input value t is a table containing</span>
<span class="comment">%option data in the required form.</span>

<span class="keyword">if</span> ~isempty( t )

    <span class="comment">% Validate the required attributes of the table variables.</span>
    expiryTime = t{:, 1};
    mustBeVector( expiryTime )
    mustBeNonnegative( expiryTime )
    mustBeFinite( expiryTime )

    strike = t{:, 2};
    mustBeVector( strike )
    mustBePositive( strike )
    mustBeFinite( strike )

    volatility = t{:, 3};
    mustBeVector( volatility )
    mustBeInRange( volatility, 0, 100, <span class="string">"exclude-lower"</span> )

    assetPrice = t{:, 4};
    mustBeVector( assetPrice )
    mustBePositive( assetPrice )
    mustBeFinite( assetPrice )

<span class="keyword">end</span> <span class="comment">% if</span>

<span class="keyword">end</span> <span class="comment">% mustBeOptionData</span>
</pre>
</div>
<!--
##### SOURCE BEGIN #####
classdef ImpliedVolatilityChart < Component
    %IMPLIEDVOLATILITYCHART Chart managing 3D scattered data comprising
    %strike price, time to expiry and implied volatility, together with an
    %interpolated implied volatility surface.

    % Copyright 2018-2025 The MathWorks, Inc.

    properties ( Dependent )
        % Table of option data, comprising the time to expiry, strike
        % price, implied volatility and underlying asset price.
        OptionData(:, 4) table {mustBeOptionData}
    end % properties ( Dependent )

    properties
        % Marker for the scattered data.
        Marker(1, 1) string {mustBeMarker} = "."
        % Size of the markers.
        MarkerSize(1, 1) double {mustBePositive, mustBeFinite} = 6
        % Marker face color.
        MarkerFaceColor {validatecolor} = "k"
        % Marker edge color.
        MarkerEdgeColor {validatecolor} = "k"
    end % properties

    properties ( Dependent, AbortSet )
        % Volatility curve interpolation method.
        InterpolationMethod(1, 1) string ...
            {mustBeMember( InterpolationMethod, ...
            ["linear", "spline", "pchip", "makima", ...
            "Hagan2002", "Obloj2008"] )} = "pchip"
    end % properties ( Dependent, AbortSet )

    properties ( Dependent )
        % Visibility of the chart controls.
        Controls(1, 1) matlab.lang.OnOffSwitchState
    end % properties ( Dependent )

    properties ( Access = private )
        % Internal storage for the OptionData property.
        OptionData_(:, 4) table {mustBeOptionData} = defaultOptionData()
        % Internal storage for the InterpolationMethod property.
        InterpolationMethod_(1, 1) string ...
            {mustBeMember( InterpolationMethod_, ...
            ["linear", "spline", "pchip", "makima", ...
            "Hagan2002", "Obloj2008"] )} = "pchip"
        % Logical scalar specifying whether a computation is required.
        ComputationRequired(1, 1) logical = false
    end % properties ( Access = private )

    properties ( Dependent, Access = private )
        % Vector of unique expiry times.
        UniqueExpiryTimes(:, 1) double {mustBePositive, mustBeFinite}
        % Vector of finely subdivided strike prices.
        FineStrike(:, 1) double {mustBePositive, mustBeFinite}
        % Surface z-data (implied volatilities).
        VolatilityGrid(:, :) double {mustBePositive, mustBeFinite}
    end % properties ( Dependent, Access = private )

    properties ( Access = private, Transient, NonCopyable )
        % Chart layout.
        LayoutGrid(:, 1) matlab.ui.container.GridLayout ...
            {mustBeScalarOrEmpty}
        % Chart axes.
        Axes(:, 1) matlab.graphics.axis.Axes ...
            {mustBeScalarOrEmpty}
        % Toggle button for the chart controls.
        ToggleButton(:, 1) matlab.ui.controls.ToolbarStateButton ...
            {mustBeScalarOrEmpty}
        % Implied volatility surface.
        Surface(:, 1) matlab.graphics.primitive.Surface ...
            {mustBeScalarOrEmpty}
        % 3D scattered data, plotted using a line object.
        Line(:, 1) matlab.graphics.primitive.Line ...
            {mustBeScalarOrEmpty}
        % Implied volatility interpolation method dropdown menu.
        InterpolationMethodDropDown(:, 1) matlab.ui.control.DropDown ...
            {mustBeScalarOrEmpty}
        % Colorbar check box.
        ColorbarCheckBox(:, 1) matlab.ui.control.CheckBox ...
            {mustBeScalarOrEmpty}
    end % properties ( Access = private, Transient, NonCopyable )

    properties ( Constant, Hidden )
        % Product dependencies.
        Dependencies(1, :) string = ["MATLAB", ...
            "Statistics and Machine Learning Toolbox", ...
            "Optimization Toolbox", ...
            "Financial Toolbox", ...
            "Financial Instruments Toolbox"]
        % Description.
        ShortDescription(1, 1) string = "Plot an implied " + ...
            "volatility surface as a function of the option strike" + ...
            " price and time to expiry"
    end % properties ( Constant, Hidden )

    methods

        function value = get.OptionData( obj )

            value = obj.OptionData_;

        end % get.OptionData

        function set.OptionData( obj, value )

            % Mark the chart for an update.
            obj.ComputationRequired = true;

            % Set the internal data property.
            obj.OptionData_ = value;

        end % set.OptionData

        function value = get.InterpolationMethod( obj )

            value = obj.InterpolationMethod_;

        end % get.InterpolationMethod

        function set.InterpolationMethod( obj, value )

            % Mark the chart for an update.
            obj.ComputationRequired = true;

            % Update the dropdown menu if necessary.
            obj.InterpolationMethodDropDown.Value = value;

            % Assign the interpolation method.
            obj.InterpolationMethod_ = value;

        end % set.InterpolationMethod

        function value = get.Controls( obj )

            value = obj.ToggleButton.Value;

        end % get.Controls

        function set.Controls( obj, value )

            % Update the toggle button.
            obj.ToggleButton.Value = value;

            % Invoke the toggle button callback.
            obj.onToggleButtonPressed()

        end % set.Controls

        function value = get.UniqueExpiryTimes( obj )

            value = unique( obj.OptionData_.(1) );

        end % get.UniqueExpiryTimes

        function value = get.FineStrike( obj )

            % Take the maximal interior domain of the strike prices across
            % each unique expiry time.
            T = obj.UniqueExpiryTimes;
            for k = numel( T ) : -1 : 1
                currentTIdx = obj.OptionData_.(1) == T(k);
                K = obj.OptionData_.(2);
                [mn(k, 1), mx(k, 1)] = bounds( K(currentTIdx) );
            end % for
            mn = max( mn );
            mx = min( mx );
            value = linspace( mn, mx, 500 ).';

        end % get.FineStrike

        function sigma = get.VolatilityGrid( obj )

            % For each unique expiry time, we interpolate the corresponding
            % volatility smile over the fine strike prices.
            T = obj.UniqueExpiryTimes;
            K = obj.FineStrike;
            interpMethod = obj.InterpolationMethod;
            sigma = NaN( numel( K ), numel( T ) );

            switch interpMethod
                % Use INTERP1 to cover the basic cases.
                case {"linear", "spline", "pchip", "makima"}
                    for k = 1 : numel( T )
                        currentTIdx = obj.OptionData_.(1) == T(k);
                        currentK = obj.OptionData_{currentTIdx, 2};
                        currentVol = obj.OptionData_{currentTIdx, 3};
                        sigma(:, k) = interp1( currentK, currentVol, ...
                            K, interpMethod );
                    end % for
                    % Otherwise, we calibrate and evaluate the SABR model
                    % to obtain the implied volatilities.
                case {"Hagan2002", "Obloj2008"}
                    sigma = sabr( obj );
                otherwise
                    error( "ImpliedVolatility:InvalidInterpMethod", ...
                        "Unrecognized interpolation method %s.", ...
                        interpMethod )
            end % switch/case

            % Ensure that all computed volatilities are nonnegative.
            sigma = max( sigma, 0 );

        end % get.VolatilityGrid

    end % methods

    methods

        function obj = ImpliedVolatilityChart( namedArgs )
            %IMPLIEDVOLATILITYCHART Construct an ImpliedVolatilityChart,
            %given optional name-value arguments.

            arguments ( Input )
                namedArgs.?ImpliedVolatilityChart
            end % arguments ( Input )

            % Set any user-defined properties.
            set( obj, namedArgs )

        end % constructor

        function varargout = xlabel( obj, varargin )

            [varargout{1:nargout}] = xlabel( obj.Axes, varargin{:} );

        end % xlabel

        function varargout = ylabel( obj, varargin )

            [varargout{1:nargout}] = ylabel( obj.Axes, varargin{:} );

        end % ylabel

        function varargout = zlabel( obj, varargin )

            [varargout{1:nargout}] = zlabel( obj.Axes, varargin{:} );

        end % zlabel

        function varargout = title( obj, varargin )

            [varargout{1:nargout}] = title( obj.Axes, varargin{:} );

        end % title

        function varargout = colorbar( obj, varargin )

            % Call the colorbar function on the chart's axes.
            [varargout{1:nargout}] = colorbar( obj.Axes, varargin{:} );

            % Ensure the colorbar check box is up-to-date.
            obj.ColorbarCheckBox.Value = ~isempty( obj.Axes.Colorbar );

        end % colorbar

        function varargout = colormap( obj, varargin )

            [varargout{1:nargout}] = colormap( obj.Axes, varargin{:} );

        end % colormap

        function varargout = view( obj, varargin )

            [varargout{1:nargout}] = view( obj.Axes, varargin{:} );

        end % view

        function varargout = axis( obj, varargin )

            [varargout{1:nargout}] = axis( obj.Axes, varargin{:} );

        end % axis

    end % methods

    methods ( Access = protected )

        function setup( obj )
            %SETUP Initialize the chart graphics.

            % Define the layout grid.
            obj.LayoutGrid = uigridlayout( obj, [1, 2], ...
                "ColumnWidth", ["1x", "0x"] );

            % Create the chart's axes.
            obj.Axes = axes( "Parent", obj.LayoutGrid, ...
                "XGrid", "on", ...
                "YGrid", "on", ...
                "ZGrid", "on" );

            % Add a state button to show/hide the chart's controls.
            tb = axtoolbar( obj.Axes, "default" );
            iconPath = fullfile( chartsRoot(), ...
                "charts", "images", "Cog.png" );
            obj.ToggleButton = axtoolbarbtn( tb, "state", ...
                "Value", "on", ...
                "Tooltip", "Show chart controls", ...
                "Icon", iconPath, ...
                "ValueChangedFcn", @obj.onToggleButtonPressed );

            % Create the line and surface plot.
            obj.Line = line( "Parent", obj.Axes, ...
                "XData", NaN(), ...
                "YData", NaN(), ...
                "ZData", NaN(), ...
                "Marker", ".", ...
                "Color", "k", ...
                "LineStyle", "none" );
            obj.Surface = surface( obj.Axes, ...
                NaN(), NaN(), NaN(), NaN(), ...
                "FaceColor", "interp", ...
                "EdgeAlpha", 0 );
            % Configure the chart's axes.
            view( obj.Axes, 3 )

            % Add the chart controls.
            p = uipanel( "Parent", obj.LayoutGrid, ...
                "Title", "Chart Controls", ...
                "FontWeight", "bold" );
            controlLayout = uigridlayout( p, [3, 2], ...
                "ColumnWidth", ["fit", "fit"], ...
                "RowHeight", ["fit", "fit", "fit"] );

            % Interpolation methods dropdown menu.
            uilabel( "Parent", controlLayout, ...
                "Text", "Interpolation method:" );
            obj.InterpolationMethodDropDown = uidropdown( ...
                "Parent", controlLayout, ...
                "Items", ["linear", "spline", "pchip", ...
                "makima", "Hagan2002", "Obloj2008"], ...
                "Tooltip", ...
                "Select the implied volatility interpolation method", ...
                "Value", obj.InterpolationMethod_, ...
                "ValueChangedFcn", @obj.onInterpolationMethodSelected );

            % Colorbar check box.
            obj.ColorbarCheckBox = uicheckbox( ...
                "Parent", controlLayout, ...
                "Text", "Colorbar", ...
                "Tooltip", "Show/hide the colorbar", ...
                "Value", false, ...
                "ValueChangedFcn", @obj.onColorbarSelected );
            obj.ColorbarCheckBox.Layout.Column = [1, 2];

        end % setup

        function update( obj )
            %UPDATE Refresh the chart graphics.

            if obj.ComputationRequired

                % Update the discrete data markers.
                set( obj.Line, "XData", obj.OptionData_.(1), ...
                    "YData", obj.OptionData_.(2), ...
                    "ZData", obj.OptionData_.(3) )

                % Update the volatility surface.
                set( obj.Surface, "XData", obj.UniqueExpiryTimes, ...
                    "YData", obj.FineStrike, ...
                    "ZData", obj.VolatilityGrid, ...
                    "CData", obj.VolatilityGrid )

                % Mark the chart clean.
                obj.ComputationRequired = false;

            end % if

            % Refresh the chart's decorative properties.
            set( obj.Line, "Marker", obj.Marker, ...
                "MarkerSize", obj.MarkerSize, ...
                "MarkerFaceColor", obj.MarkerFaceColor, ...
                "MarkerEdgeColor", obj.MarkerEdgeColor )

        end % update

    end % methods ( Access = protected )

    methods ( Access = private )

        function onToggleButtonPressed( obj, ~, ~ )
            %ONTOGGLEBUTTONPRESSED Hide/show the chart controls.

            toggleDown = obj.ToggleButton.Value;

            if toggleDown
                % Show the controls.
                obj.LayoutGrid.ColumnWidth{2} = "fit";
                obj.ToggleButton.Tooltip = "Hide chart controls";
            else
                % Hide the controls.
                obj.LayoutGrid.ColumnWidth{2} = "0x";
                obj.ToggleButton.Tooltip = "Show chart controls";
            end % if

        end % onToggleButtonPressed

        function onInterpolationMethodSelected( obj, ~, ~ )
            %ONINTERPOLATIONMETHODSELECTED Update the chart when the user
            %interactively selects an interpolation method.

            obj.InterpolationMethod = ...
                obj.InterpolationMethodDropDown.Value;

        end % onInterpolationMethodSelected

        function onColorbarSelected( obj, ~, ~ )
            %ONCOLORBARSELECTED Show/hide the colorbar.

            checked = obj.ColorbarCheckBox.Value;
            if checked
                colorbar( obj )
            else
                colorbar( obj, "off" )
            end % if

        end % onColorbarSelected

        function sigma = sabr( obj )
            %SABR Evaluate the implied volatility surface using the SABR
            %model.

            % Define the settlement date (an arbitrary date since we are
            % working with times to expiry). The exercise date will be the
            % settlement date plus the time to expiry.
            settle = datetime( 2000, 1, 1 );

            % For each unique time to expiry, we calibrate the SABR model
            % The calibrated SABR model is then used to interpolate the
            % implied volatilities across the range of finely subdivided
            % strike prices.
            T = obj.UniqueExpiryTimes;
            for k = numel( T ) : -1 : 1
                % Compute the exercise date.
                exercise = settle + years( T(k) );
                % Extract the (K, sigma) values for each expiry time.
                currentTIdx = obj.OptionData_.(1) == T(k);
                strike = obj.OptionData_{currentTIdx, 2};
                vol = obj.OptionData_{currentTIdx, 3};
                underlyingPrice = obj.OptionData_{currentTIdx, 4};
                % Calibrate the other parameters alpha, rho and nu using
                % nonlinear least squares.
                objFun = @( X ) vol - ...
                    blackvolbysabr( X(1), X(2), X(3), X(4), settle, ...
                    exercise, underlyingPrice, strike, ...
                    "Model", obj.InterpolationMethod );
                opts = optimoptions( "lsqnonlin", "Display", "off" );
                X = lsqnonlin( objFun, [0.5, 0.2, 0, 0.5], ...
                    [0, 0, -1, 0], [Inf, 1, 1, Inf], opts );
                % Interpolate the volatilities using the calibrated model.
                sigma(:, k) = blackvolbysabr( X(1), X(2), X(3), X(4), ...
                    settle, exercise, ...
                    mean( underlyingPrice ), obj.FineStrike );
            end % for

        end % sabr

    end % methods ( Access = protected )

end % classdef

function optData = defaultOptionData()
%DEFAULTOPTIONDATA Create an empty table of option data.

optData = table( 'Size', [0, 4], ...
    'VariableTypes', ["double", "double", "double", "double"], ...
    'VariableNames', ["T", "K", "Sigma", "S"] );

end % defaultOptionData

function mustBeOptionData( t )
%MUSTBEOPTIONDATA Validate that the input value t is a table containing
%option data in the required form.

if ~isempty( t )

    % Validate the required attributes of the table variables.
    expiryTime = t{:, 1};
    mustBeVector( expiryTime )
    mustBeNonnegative( expiryTime )
    mustBeFinite( expiryTime )

    strike = t{:, 2};
    mustBeVector( strike )
    mustBePositive( strike )
    mustBeFinite( strike )

    volatility = t{:, 3};
    mustBeVector( volatility )
    mustBeInRange( volatility, 0, 100, "exclude-lower" )

    assetPrice = t{:, 4};
    mustBeVector( assetPrice )
    mustBePositive( assetPrice )
    mustBeFinite( assetPrice )

end % if

end % mustBeOptionData
##### SOURCE END #####
-->
</body>
</html>
